---
config:
  look: handDrawn
  theme: neutral
---

sequenceDiagram
    participant U as ðŸ‘¤ Campaign Owner
    participant F as ðŸŽ¨ Frontend
    participant SDK as ðŸ” FHEVM SDK
    participant CF as ðŸ“ ConfidentialFundraising
    participant SV as ðŸ’° ShareVault
    participant CT as ðŸª™ CampaignToken

    U->>F: Click "Finalize Campaign"
    F->>F: Check deadline passed

    F->>CF: getEncryptedTotalRaised(campaignId)
    CF-->>F: encryptedTotal
    F->>SDK: Decrypt total amount
    SDK-->>F: decryptedTotal

    F->>F: Display total to owner
    U->>F: Confirm finalization<br/>(provide token name & symbol)

    F->>CF: finalizeCampaign(campaignId, tokenName, tokenSymbol)

    alt Target Reached âœ…
        CF->>CT: Deploy new CampaignToken
        CT-->>CF: Token contract address
        CF->>SV: transferLockedFunds(owner, campaignId)
        SV->>SV: Calculate total locked for campaign
        SV->>SV: Unlock all contributor funds
        SV->>SV: Transfer ETH to owner
        SV-->>CF: âœ… Funds transferred
        CF->>CF: Mark campaign successful
        CF-->>F: âœ… Campaign finalized successfully
        F-->>U: "ðŸŽ‰ Campaign successful!<br/>Contributors can claim tokens"
    else Target Not Reached âŒ
        CF->>SV: unlockFunds(campaignId)
        SV->>SV: Unlock all contributor funds
        SV-->>CF: âœ… Funds unlocked
        CF->>CF: Mark campaign failed
        CF-->>F: âŒ Campaign failed
        F-->>U: "Campaign failed.<br/>Refunds available to contributors"
    end